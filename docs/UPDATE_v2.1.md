# 激活系统更新说明 v2.1

## 🎉 新功能

### 1. 设备备注功能

现在可以为每个设备添加备注，方便识别设备所有者！

#### 功能特点
- ✅ 每个设备可添加最多 200 字符的备注
- ✅ 在设备列表中直接显示备注
- ✅ 点击 ✏️ 按钮快速编辑备注
- ✅ 备注信息存储在数据库中

#### 使用方法

**在 Web 管理后台：**
1. 打开设备管理页面
2. 找到需要添加备注的设备
3. 点击备注列的 ✏️ 按钮
4. 输入备注信息（如：张三的设备、办公室电视等）
5. 点击"保存"按钮

**备注示例：**
- "张三的手机"
- "会议室电视"
- "测试设备 - 勿删"
- "VIP 用户 - 李四"

### 2. 3天免费试用

新机器码首次使用时自动获得 3 天免费试用！

#### 功能特点
- ✅ 新设备首次启动自动激活
- ✅ 无需输入激活码
- ✅ 自动获得 3 天试用期
- ✅ 试用期结束后需要输入激活码

#### 工作流程

1. **用户首次打开 APP**
   - 系统检测到新机器码
   - 自动创建 3 天免费试用
   - 显示提示："欢迎使用！已自动激活3天免费试用"

2. **试用期内**
   - 正常使用所有功能
   - 显示剩余天数
   - 可以随时输入激活码延长

3. **试用期结束后**
   - 提示试用已过期
   - 需要输入激活码继续使用

#### 在 Web 后台查看

试用设备会显示：
- 激活码：`FREE-TRIAL-3DAY`
- 备注：`3天免费试用`
- 状态：根据剩余天数显示

---

## 📊 数据库更新

### 新增字段

在 `activation_records` 表中添加了 `device_note` 字段：

```sql
ALTER TABLE activation_records 
ADD COLUMN IF NOT EXISTS device_note VARCHAR(200) DEFAULT NULL;
```

### 更新方法

#### 方法 1：在 Neon Console 执行

```sql
ALTER TABLE activation_records 
ADD COLUMN IF NOT EXISTS device_note VARCHAR(200) DEFAULT NULL;
```

#### 方法 2：使用提供的脚本

在 Neon Console 的 SQL Editor 中执行：
```
server/database/add_device_note.sql
```

---

## 🔧 API 更新

### 新增 API

#### 更新设备备注
```
POST /api/admin/update_note
Content-Type: application/json

{
  "machine_code": "A1B2C3D4E5F6G7H8",
  "note": "张三的设备"
}
```

**响应示例：**
```json
{
  "status": "success",
  "message": "备注更新成功",
  "data": {
    "machine_code": "A1B2C3D4E5F6G7H8",
    "note": "张三的设备"
  }
}
```

### 修改的 API

#### 检查激活状态 (check.php)
- 新增：检测到新机器码时自动创建 3 天试用
- 返回：试用信息包含在响应中

#### 设备列表 (devices.php)
- 新增：返回数据中包含 `device_note` 字段

---

## 🌐 Web 管理后台更新

### 设备管理页面

**新增列：**
- 备注列（在机器码后面）
- 显示设备备注或"未设置"
- 包含 ✏️ 编辑按钮

**新增对话框：**
- 编辑备注对话框
- 输入框支持最多 200 字符
- 实时保存到数据库

### 表格布局

更新后的表格列：
1. 机器码
2. **备注** ← 新增
3. 激活码
4. 激活时间
5. 过期时间
6. 剩余天数
7. 状态
8. 操作

---

## 📱 客户端体验

### 首次使用流程

1. **用户下载并打开 APP**
   ```
   → 系统检测机器码
   → 发现是新设备
   → 自动创建 3 天试用
   → 显示："欢迎使用！已自动激活3天免费试用"
   ```

2. **试用期内**
   ```
   → 正常使用
   → 状态栏显示："剩余 X 天"
   → 可随时输入激活码延长
   ```

3. **试用期结束**
   ```
   → 显示："试用已过期"
   → 提示输入激活码
   → 输入激活码后继续使用
   ```

---

## 🎯 使用场景

### 场景 1：新用户体验

**之前：**
- 用户下载 APP
- 必须联系管理员获取激活码
- 才能开始使用

**现在：**
- 用户下载 APP
- 自动获得 3 天试用
- 立即开始使用
- 满意后再购买激活码

### 场景 2：设备管理

**之前：**
- 只能看到机器码
- 不知道是谁的设备
- 需要另外记录

**现在：**
- 直接在后台添加备注
- 一目了然知道设备所有者
- 方便管理和延长

### 场景 3：批量管理

**示例：**
```
机器码              备注                状态
A1B2C3D4E5F6G7H8   张三 - VIP用户      已激活 (30天)
B2C3D4E5F6G7H8I9   李四 - 测试设备      即将过期 (5天)
C3D4E5F6G7H8I9J0   王五 - 办公室TV      已过期
D4E5F6G7H8I9J0K1   新用户试用          试用中 (2天)
```

---

## 🔄 升级步骤

### 1. 更新数据库

在 Neon Console 执行：
```sql
ALTER TABLE activation_records 
ADD COLUMN IF NOT EXISTS device_note VARCHAR(200) DEFAULT NULL;
```

### 2. 更新服务器文件

上传以下文件到服务器：
- `server/api/check.php` （已修改）
- `server/api/admin/devices.php` （已修改）
- `server/api/admin/update_note.php` （新增）
- `server/index.php` （已修改）

### 3. 更新 Web 管理后台

上传以下文件：
- `web_admin/index.html` （已修改）
- `web_admin/script.js` （已修改）

### 4. 测试功能

1. 访问 Web 管理后台
2. 查看设备列表是否显示备注列
3. 尝试编辑一个设备的备注
4. 使用新机器码测试 3 天试用

---

## ✅ 功能清单

### 设备备注
- [x] 数据库添加 device_note 字段
- [x] API 支持更新备注
- [x] API 返回备注信息
- [x] Web 后台显示备注列
- [x] Web 后台编辑备注对话框
- [x] 备注长度限制（200字符）
- [x] HTML 转义防止 XSS

### 3天免费试用
- [x] 检测新机器码
- [x] 自动创建试用记录
- [x] 设置 3 天过期时间
- [x] 标记为试用设备
- [x] 返回试用信息
- [x] 客户端显示试用提示

---

## 📝 注意事项

### 备注功能
1. 备注最多 200 个字符
2. 支持中文、英文、数字、符号
3. 备注可以为空
4. 备注会自动 HTML 转义

### 免费试用
1. 每个机器码只能试用一次
2. 试用期固定为 3 天
3. 试用期结束后需要激活码
4. 试用设备可以正常延长时间

---

## 🎉 总结

这次更新带来了两个重要功能：

1. **设备备注** - 让设备管理更加清晰
2. **3天免费试用** - 降低用户使用门槛

现在您可以：
- ✅ 轻松识别每个设备的所有者
- ✅ 让新用户先试用再决定购买
- ✅ 更好地管理所有设备

升级愉快！🚀
