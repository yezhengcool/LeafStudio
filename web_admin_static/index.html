<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¿€æ´»ç³»ç»Ÿç®¡ç†åå°</title>
    <link rel="stylesheet" href="style.css">

    <!-- é˜²æ­¢æœªç™»å½•æ—¶é¡µé¢é—ªçƒ -->
    <style>
        body {
            visibility: hidden;
        }

        body.loaded {
            visibility: visible;
        }
    </style>

    <!-- ç™»å½•æ£€æŸ¥ - å¿…é¡»åœ¨é¡µé¢åŠ è½½å‰æ‰§è¡Œ -->
    <script>
        // ç«‹å³æ£€æŸ¥ç™»å½•çŠ¶æ€
        (function () {
            const isLoggedIn = localStorage.getItem('admin_logged_in');
            if (isLoggedIn !== 'true') {
                // æœªç™»å½•ï¼Œç«‹å³è·³è½¬åˆ°ç™»å½•é¡µ
                window.location.href = 'login.html';
            } else {
                // å·²ç™»å½•ï¼Œæ˜¾ç¤ºé¡µé¢
                document.addEventListener('DOMContentLoaded', function () {
                    document.body.classList.add('loaded');
                });
            }
        })();
    </script>
</head>

<body>
    <!-- è°ƒè¯•æ§åˆ¶å° -->
    <div id="debug-console"
        style="display:none; position:fixed; top:0; left:0; right:0; background:rgba(0,0,0,0.8); color:#0f0; padding:10px; font-family:monospace; font-size:12px; z-index:9999; max-height:200px; overflow:auto;">
    </div>

    <script>
        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function log(msg) {
            console.log(msg);
            var consoleDiv = document.getElementById('debug-console');
            if (consoleDiv) {
                consoleDiv.style.display = 'block';
                consoleDiv.innerHTML += '<div>> ' + msg + '</div>';
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }
        }

        // å…¨å±€é”™è¯¯æ•è·
        window.onerror = function (msg, url, line, col, error) {
            log("âŒ é”™è¯¯: " + msg + "\nğŸ“ " + line + "è¡Œ");
            return false;
        };

        window.addEventListener('unhandledrejection', function (event) {
            log("âš ï¸ å¼‚æ­¥é”™è¯¯: " + (event.reason ? event.reason.message : event.reason));
        });

        log('ç®¡ç†åå°é¡µé¢å¼€å§‹åŠ è½½...');
    </script>

    <div class="container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="logo">
                <h2>ğŸƒ LeafStudio</h2>
                <p>æ¿€æ´»ç®¡ç†ç³»ç»Ÿ</p>
            </div>
            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-page="devices">
                    <span class="icon">ğŸ“±</span>
                    <span>è®¾å¤‡ç®¡ç†</span>
                </a>
                <a href="#" class="nav-item" data-page="codes">
                    <span class="icon">ğŸ«</span>
                    <span>æ¿€æ´»ç ç®¡ç†</span>
                </a>
                <a href="#" class="nav-item" data-page="statistics">
                    <span class="icon">ğŸ“Š</span>
                    <span>ç»Ÿè®¡åˆ†æ</span>
                </a>
                <a href="#" class="nav-item" data-page="settings">
                    <span class="icon">âš™ï¸</span>
                    <span>ç³»ç»Ÿè®¾ç½®</span>
                </a>
            </nav>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <!-- å¤´éƒ¨ -->
            <header class="header">
                <div class="header-left">
                    <h1 id="page-title">è®¾å¤‡ç®¡ç†</h1>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <span>ç®¡ç†å‘˜</span>
                        <button class="btn-logout" onclick="logout()">é€€å‡º</button>
                    </div>
                </div>
            </header>

            <!-- è®¾å¤‡ç®¡ç†é¡µé¢ -->
            <div id="devices-page" class="page active">
                <div class="page-header">
                    <div class="search-box">
                        <input type="text" id="device-search" placeholder="æœç´¢æœºå™¨ç æˆ–æ¿€æ´»ç ...">
                        <button onclick="searchDevices()">ğŸ” æœç´¢</button>
                    </div>
                    <div class="filter-box">
                        <select id="device-filter" onchange="filterDevices()">
                            <option value="all">å…¨éƒ¨è®¾å¤‡</option>
                            <option value="active">å·²æ¿€æ´»</option>
                            <option value="expired">å·²è¿‡æœŸ</option>
                            <option value="expiring">å³å°†è¿‡æœŸ</option>
                        </select>
                        <button onclick="refreshDevices()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                </div>

                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“±</div>
                        <div class="stat-info">
                            <div class="stat-value" id="total-devices">0</div>
                            <div class="stat-label">æ€»è®¾å¤‡æ•°</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-info">
                            <div class="stat-value" id="active-devices">0</div>
                            <div class="stat-label">å·²æ¿€æ´»</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">â°</div>
                        <div class="stat-info">
                            <div class="stat-value" id="expiring-devices">0</div>
                            <div class="stat-label">å³å°†è¿‡æœŸ</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âŒ</div>
                        <div class="stat-info">
                            <div class="stat-value" id="expired-devices">0</div>
                            <div class="stat-label">å·²è¿‡æœŸ</div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æœºå™¨ç </th>
                                <th>å¤‡æ³¨</th>
                                <th>æ¿€æ´»ç </th>
                                <th>æ¿€æ´»æ—¶é—´</th>
                                <th>è¿‡æœŸæ—¶é—´</th>
                                <th>å‰©ä½™å¤©æ•°</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="devices-table-body">
                            <!-- æ•°æ®å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æ¿€æ´»ç ç®¡ç†é¡µé¢ -->
            <div id="codes-page" class="page">
                <div class="page-header">
                    <button class="btn-primary" onclick="showGenerateCodesDialog()">
                        â• ç”Ÿæˆæ¿€æ´»ç 
                    </button>
                    <button onclick="refreshCodes()">ğŸ”„ åˆ·æ–°</button>
                </div>

                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ«</div>
                        <div class="stat-info">
                            <div class="stat-value" id="total-codes">0</div>
                            <div class="stat-label">æ€»æ¿€æ´»ç </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-info">
                            <div class="stat-value" id="used-codes">0</div>
                            <div class="stat-label">å·²ä½¿ç”¨</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">â­•</div>
                        <div class="stat-info">
                            <div class="stat-value" id="unused-codes">0</div>
                            <div class="stat-label">æœªä½¿ç”¨</div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ¿€æ´»ç </th>
                                <th>æœ‰æ•ˆå¤©æ•°</th>
                                <th>çŠ¶æ€</th>
                                <th>ä½¿ç”¨è®¾å¤‡</th>
                                <th>ä½¿ç”¨æ—¶é—´</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="codes-table-body">
                            <!-- æ•°æ®å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ç»Ÿè®¡åˆ†æé¡µé¢ -->
            <div id="statistics-page" class="page">
                <h2>ç»Ÿè®¡åˆ†æ</h2>
                <div class="chart-container">
                    <canvas id="activation-chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="expiry-chart"></canvas>
                </div>
            </div>

            <!-- ç³»ç»Ÿè®¾ç½®é¡µé¢ -->
            <div id="settings-page" class="page">
                <h2>ç³»ç»Ÿè®¾ç½®</h2>

                <div class="settings-section">
                    <h3>è´¦æˆ·è®¾ç½®</h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label>å½“å‰ç”¨æˆ·å</label>
                            <input type="text" id="current-username" readonly>
                        </div>
                        <div class="form-group">
                            <label>ç™»å½•æ—¶é—´</label>
                            <input type="text" id="login-time" readonly>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>ä¿®æ”¹å¯†ç </h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label>å½“å‰å¯†ç </label>
                            <input type="password" id="current-password" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç ">
                        </div>
                        <div class="form-group">
                            <label>æ–°å¯†ç </label>
                            <input type="password" id="new-password" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
                        </div>
                        <div class="form-group">
                            <label>ç¡®è®¤æ–°å¯†ç </label>
                            <input type="password" id="confirm-password" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                        </div>
                        <button class="btn-primary" onclick="changePassword()">ä¿®æ”¹å¯†ç </button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>API é…ç½®</h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label>API åœ°å€</label>
                            <input type="text" id="api-url" value="https://yezheng.dpdns.org/tv/api">
                        </div>
                        <button class="btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- å»¶é•¿æ¿€æ´»å¯¹è¯æ¡† -->
    <div id="extend-dialog" class="dialog-overlay">
        <div class="dialog">
            <div class="dialog-header">
                <h3>å»¶é•¿æ¿€æ´»æ—¶é—´</h3>
                <button class="dialog-close" onclick="closeDialog('extend-dialog')">Ã—</button>
            </div>
            <div class="dialog-body">
                <div class="form-group">
                    <label>æœºå™¨ç </label>
                    <input type="text" id="extend-machine-code" readonly>
                </div>
                <div class="form-group">
                    <label>å½“å‰è¿‡æœŸæ—¶é—´</label>
                    <input type="text" id="extend-current-expiry" readonly>
                </div>
                <div class="form-group">
                    <label>å»¶é•¿å¤©æ•°</label>
                    <input type="number" id="extend-days" value="30" min="1">
                </div>
                <div class="form-group">
                    <label>æ–°è¿‡æœŸæ—¶é—´</label>
                    <input type="text" id="extend-new-expiry" readonly>
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn-secondary" onclick="closeDialog('extend-dialog')">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="confirmExtend()">ç¡®è®¤å»¶é•¿</button>
            </div>
        </div>
    </div>

    <!-- ç”Ÿæˆæ¿€æ´»ç å¯¹è¯æ¡† -->
    <div id="generate-dialog" class="dialog-overlay">
        <div class="dialog">
            <div class="dialog-header">
                <h3>ç”Ÿæˆæ¿€æ´»ç </h3>
                <button class="dialog-close" onclick="closeDialog('generate-dialog')">Ã—</button>
            </div>
            <div class="dialog-body">
                <div class="form-group">
                    <label>ç”Ÿæˆæ•°é‡</label>
                    <input type="number" id="generate-count" value="10" min="1" max="1000">
                </div>
                <div class="form-group">
                    <label>æœ‰æ•ˆå¤©æ•°</label>
                    <select id="generate-days">
                        <option value="7">7å¤©ï¼ˆè¯•ç”¨ï¼‰</option>
                        <option value="30" selected>30å¤©ï¼ˆæœˆå¡ï¼‰</option>
                        <option value="90">90å¤©ï¼ˆå­£å¡ï¼‰</option>
                        <option value="180">180å¤©ï¼ˆåŠå¹´å¡ï¼‰</option>
                        <option value="365">365å¤©ï¼ˆå¹´å¡ï¼‰</option>
                        <option value="1825">1825å¤©ï¼ˆ5å¹´ï¼‰</option>
                    </select>
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn-secondary" onclick="closeDialog('generate-dialog')">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="confirmGenerate()">å¼€å§‹ç”Ÿæˆ</button>
            </div>
        </div>
    </div>

    <!-- è®¾å¤‡è¯¦æƒ…å¯¹è¯æ¡† -->
    <div id="device-detail-dialog" class="dialog-overlay">
        <div class="dialog">
            <div class="dialog-header">
                <h3>è®¾å¤‡è¯¦æƒ…</h3>
                <button class="dialog-close" onclick="closeDialog('device-detail-dialog')">Ã—</button>
            </div>
            <div class="dialog-body">
                <div id="device-detail-content"></div>
            </div>
            <div class="dialog-footer">
                <button class="btn-secondary" onclick="closeDialog('device-detail-dialog')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å¤‡æ³¨å¯¹è¯æ¡† -->
    <div id="edit-note-dialog" class="dialog-overlay">
        <div class="dialog">
            <div class="dialog-header">
                <h3>ç¼–è¾‘è®¾å¤‡å¤‡æ³¨</h3>
                <button class="dialog-close" onclick="closeDialog('edit-note-dialog')">Ã—</button>
            </div>
            <div class="dialog-body">
                <div class="form-group">
                    <label>æœºå™¨ç </label>
                    <input type="text" id="edit-note-machine-code" readonly>
                </div>
                <div class="form-group">
                    <label>è®¾å¤‡å¤‡æ³¨</label>
                    <input type="text" id="edit-note-input" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼Œå¦‚ï¼šå¼ ä¸‰çš„è®¾å¤‡" maxlength="200">
                    <small style="color: #9ca3af; margin-top: 0.5rem; display: block;">
                        æœ€å¤š 200 ä¸ªå­—ç¬¦ï¼Œç”¨äºæ ‡è¯†è®¾å¤‡æ‰€æœ‰è€…æˆ–ç”¨é€”
                    </small>
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn-secondary" onclick="closeDialog('edit-note-dialog')">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="confirmEditNote()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- MD5 åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>

    <!-- æ·»åŠ ç‰ˆæœ¬å·é˜²æ­¢ç¼“å­˜ -->
    <script type="module" src="script.js?v=20251126"></script>
</body>

</html>