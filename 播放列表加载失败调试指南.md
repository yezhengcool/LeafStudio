# 🐛 播放列表加载失败 - 调试指南

## 问题描述
APP显示"加载播放列表失败"错误

## 可能的原因

### 1. 网络连接问题
- 设备未连接网络
- 网络权限被拒绝
- 防火墙阻止

### 2. URL配置问题
- 播放列表URL无法访问
- URL格式错误

### 3. 激活系统问题
- 机器码变化导致激活检查失败
- 激活API无法访问

## 🔧 解决方案

### 方案1：检查网络权限

确保APP具有网络权限：

**Android 6.0+需要运行时权限：**
1. 设置 → 应用管理 → LeafStudio
2. 权限 → 确保以下权限已启用：
   - ✅ 网络访问
   - ✅ 位置信息（用于获取天气）

### 方案2：查看详细日志

使用adb查看详细的错误信息：

```bash
# 连接设备后运行
adb logcat | grep -E "PlaylistLoader|ActivationManager|MainActivity"
```

**关键日志：**
- `PlaylistLoader: 开始加载播放列表` - 开始加载
- `PlaylistLoader: 响应状态码: 200` - HTTP状态
- `PlaylistLoader: 播放列表加载成功` - 成功
- `ActivationManager: Generated Machine Code` - 机器码生成
- `ActivationManager: Device Info` - 设备信息

### 方案3：检查播放列表URL

当前配置的URL：
```
https://yezheng.dpdns.org/tv/ydtv.txt
```

**测试URL是否可访问：**
```bash
curl -I https://yezheng.dpdns.org/tv/ydtv.txt
```

**预期结果：**
```
HTTP/2 200
content-type: text/plain
```

### 方案4：检查机器码问题

新版本使用了新的机器码算法，可能导致：
- 旧的激活记录失效  
- 需要重新激活

**查看机器码：**
1. 打开APP
2. 如果显示激活对话框，记录机器码
3. 在后台为新机器码生成激活码

### 方案5：跳过激活检查（临时测试）

如果需要临时跳过激活检查进行测试，可以修改代码：

```kotlin
// 在 PlaybackActivity.kt 的 onCreate 中
// 注释掉激活检查代码（仅用于测试）
lifecycleScope.launch {
    // val info = ActivationManager.checkActivationStatus(this@PlaybackActivity)
    // if (!info.isValid) {
    //     showActivationDialog()
    //     return@launch
    // }
}
```

## 📊 错误信息对照表

| 错误信息 | 可能原因 | 解决方法 |
|---------|---------|---------|
| "加载播放列表失败: HTTP 404" | URL不存在 | 检查URL配置 |
| "加载播放列表失败: HTTP 500" | 服务器错误 | 稍后重试 |
| "播放列表内容为空" | 服务器返回空内容 | 检查URL |
| "网络错误: timeout" | 网络超时 | 检查网络连接 |
| "网络错误: UnknownHostException" | DNS解析失败 | 检查域名和DNS |
| "网络错误: SSLException" | SSL证书问题 | 检查网络安全配置 |

## 🔍 调试步骤

### 步骤1：启用ADB调试

```bash
# 1. 在手机上启用开发者选项和USB调试
# 2. 连接电脑
# 3. 运行：
adb devices

# 应该显示你的设备
```

### 步骤2：安装新版APK

```bash
# 卸载旧版本
adb uninstall com.leafstudio.tvplayer

# 安装新版本
adb install ~/Desktop/LeafStudio-v2.1.7-debug-新机器码方案.apk
```

### 步骤3：查看实时日志

```bash
# 清除旧日志
adb logcat -c

# 启动APP并查看日志
adb logcat | grep -E "PlaylistLoader|ActivationManager|MainActivity|ERROR"
```

### 步骤4：分析日志

**成功的日志应该是：**
```
D/PlaylistLoader: 开始加载播放列表: https://yezheng.dpdns.org/tv/ydtv.txt
D/PlaylistLoader: 发送网络请求...
D/PlaylistLoader: 响应状态码: 200
D/PlaylistLoader: 播放列表加载成功，长度: XXXX 字节
D/MainActivity: 正在解析频道...
```

**如果失败，会看到：**
```
E/PlaylistLoader: 加载播放列表异常
E/PlaylistLoader: 具体错误信息...
```

### 步骤5：  测试机器码

查看新机器码：
```bash
adb logcat | grep "Machine Code"
```

应该看到：
```
D/ActivationManager: Device Info for Machine Code: samsung|samsung|...
D/ActivationManager: Generated Machine Code: XXXXXXXXXXXXXXXX
```

## 💡 常见问题

### Q1: 为什么重新安装后机器码变了？

**A:** 旧版本使用ANDROID_ID生成机器码，受应用签名影响。新版本已修复，使用硬件信息生成，不受签名影响。

**解决方法：**
- 使用新机器码重新激活
- 或在后台添加新旧机器码映射

### Q2: 激活对话框一直显示"检查中..."

**A:** 可能是激活API无法访问。

**解决方法：**
```bash
# 测试API是否可访问
curl -X POST https://yezheng.dpdns.org/api/activation.php \
  -H "Content-Type: application/json" \
  -d '{"action":"check","machineCode":"TEST1234"}'
```

### Q3: 播放列表可以访问，但APP还是提示失败

**A:** 可能是在激活检查阶段失败。

**调试步骤：**
1. 查看logcat确认是哪个环节失败
2. 如果是激活检查失败，查看机器码是否正确
3. 确认激活API是否正常

### Q4: 网络权限已授予，但还是无法加载

**A:** 检查网络安全配置。

**解决方法：**
```xml
<!-- 确保 network_security_config.xml 包含： -->
<base-config cleartextTrafficPermitted="true">
    <trust-anchors>
        <certificates src="system" />
    </trust-anchors>
</base-config>
```

## 📱 测试清单

在反馈问题前，请完成以下测试：

- [ ] 设备已连接网络（WiFi或移动数据）
- [ ] APP具有网络权限
- [ ] 使用adb查看了详细日志
- [ ] 确认播放列表URL可以访问
- [ ] 记录了机器码
- [ ] 如果有激活对话框，尝试点击"刷新状态"

## 🆘 反馈信息模板

如果问题仍未解决，请提供以下信息：

```
设备信息：
- 品牌型号：____________________
- Android版本：__________________
- 机器码：______________________

错误信息：
- APP显示的错误：________________
- logcat日志：___________________

测试结果：
- 播放列表URL是否可访问：[ ] 是 [ ] 否
- 激活API是否可访问：[ ] 是 [ ] 否
- 是否有激活对话框：[ ] 是 [ ] 否
- 机器码是否显示：[ ] 是 [ ] 否
```

## 🔄 最新修改（v2.1.7）

1. ✅ 修复机器码生成逻辑（使用硬件信息，不受签名影响）
2. ✅ 添加详细的网络请求日志
3. ✅ 增加User-Agent标识
4. ✅ 优化错误提示信息

---

**文件位置：**
- 新APK：`~/Desktop/LeafStudio-v2.1.7-debug-新机器码方案.apk`
- 源码：`/Users/mac/Desktop/LeafStudio/`
