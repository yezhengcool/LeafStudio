# 机器码问题解决方案 - 测试说明

## 📋 问题分析

### 原始问题
- 同一台安卓手机安装不同的APK包（debug版本、release版本），机器码会改变
- 导致激活状态失效

### 根本原因
在 **Android 8.0+（API 26+）**中：
- `ANDROID_ID` 会根据**应用签名密钥 + 包名**生成
- Debug签名 ≠ Release签名 → Android ID不同 → 机器码不同

## 🔧 解决方案

### 新的机器码生成逻辑
使用**设备硬件信息组合**，不受应用签名影响：

```kotlin
机器码 = MD5(
    BOARD |          // 主板名称
    BRAND |          // 品牌
    DEVICE |         // 设备名
    HARDWARE |       // 硬件名称
    MANUFACTURER |   // 制造商
    PRODUCT |        // 产品名称
    MODEL |          // 型号
    SERIAL |         // 序列号（仅Android 8.0以下）
    MAC_ADDRESS      // WiFi Mac地址（如果能获取）
).substring(0, 16).toUpperCase()
```

### 方案优势
✅ **不受签名影响** - Debug版和Release版机器码相同
✅ **无需权限** - 所有信息都可以直接获取
✅ **高度稳定** - 除非刷机/恢复出厂设置才会改变
✅ **唯一性高** - 多个硬件字段组合，几乎不可能重复
✅ **向后兼容** - 重新安装、清除数据都不影响

## 🧪 测试步骤

### 步骤1：安装新版本APK
```bash
# APK已生成到桌面
文件名：LeafStudio-v2.1.7-debug-新机器码方案.apk
```

1. 将APK传输到你的Android手机
2. 安装APK
3. 打开APP，查看激活对话框中的机器码
4. **记录机器码**（例如：A1B2C3D4E5F6G7H8）

### 步骤2：卸载后重新安装
1. 完全卸载APP
2. 重新安装同一个APK
3. 打开APP，再次查看机器码
4. **确认机器码是否与步骤1相同**

### 步骤3：清除数据后测试
1. 设置 → 应用管理 → LeafStudio
2. 点击"清除数据"或"清除所有数据"
3. 打开APP，再次查看机器码
4. **确认机器码是否保持不变**

### 步骤4：编译Release版测试（可选）
如果你想验证Debug和Release版本的机器码一致性：

```bash
# 在项目目录运行
cd /Users/mac/Desktop/LeafStudio
./gradlew assembleRelease
```

生成Release版APK后，在同一台设备上安装，确认机器码是否相同。

## 📊 预期结果

| 操作 | 机器码是否改变 | 说明 |
|-----|------------|------|
| 首次安装 | N/A | 生成机器码 |
| 卸载后重新安装 | ❌ **不变** | ✅ 已解决 |
| 清除应用数据 | ❌ **不变** | ✅ 已解决 |
| Debug → Release | ❌ **不变** | ✅ 已解决 |
| 恢复出厂设置 | ✅ **会变** | ⚠️ 硬件信息重置 |
| 刷机/换ROM | ✅ **会变** | ⚠️ 系统级改变 |

## 🔍 调试信息

新版本会在 Logcat 中输出调试信息：

```bash
# 查看机器码生成日志
adb logcat | grep ActivationManager
```

你会看到类似以下的日志：
```
D/ActivationManager: Device Info for Machine Code: samsung|samsung|SM-G973F|exynos9820|...
D/ActivationManager: Generated Machine Code: A1B2C3D4E5F6G7H8
```

## ⚠️ 重要提示

### 现有激活用户的影响
- **机器码会改变**：因为算法完全不同了
- **需要重新激活**：旧的激活码绑定的是旧机器码
- **建议操作**：
  1. 让现有用户记录新的机器码
  2. 在后台使用新机器码重新生成激活码
  3. 或者在后台手动关联新旧机器码

### 数据库迁移建议
如果有很多现有用户，可以考虑：
1. 在后台添加一个"机器码映射表"
2. 记录每个用户的旧机器码 → 新机器码映射
3. 激活检查时同时查询新旧两个机器码

## 📝 下一步

1. **测试新APK** - 按照上述步骤验证机器码稳定性
2. **确认结果** - 如果机器码在重装后保持不变，问题解决✅
3. **考虑迁移** - 如果需要保留老用户的激活状态，请告诉我，我可以帮你实现兼容方案

---

**文件位置：**
- APK: `~/Desktop/LeafStudio-v2.1.7-debug-新机器码方案.apk`
- 源码: `/Users/mac/Desktop/LeafStudio/app/src/main/java/com/leafstudio/tvplayer/utils/ActivationManager.kt`
